# grafana-loki-promtail

## Разворачивание на локальной машине
1. Настроить .env файл - натравить `PROMTAIL_LOCAL_LOGS` на папку с исследуемыми логами (абсолютный путь). Пример есть в example.env. Остальные части конфига можно целиком копировать из example.env.
2. Создать папку log, в которую закидываются логи на анализ. Либо можно миновать этот подход просто натравив `PROMTAIL_LOCAL_LOGS` на целевую папку. Оба подхода имеют место быть.
3. Запустить docker-compose через утилиту task или любым другим удобным способом.   
```bash
docker compose -f docker-compose.yaml up -d --build
```
4. Проверить что все запустилось можно перейдя по localhost:9080 (promtail), localhost:3100 (loki), localhost:3000 (grafana).
5. Поздравляю! Вы прекрасны.

```
# Примерно так выглядит мое файловое дерево при работе
.
├── log # Папка, в которую я закидываю .log файлы для анализа
├── loki/
│   └── config.yaml
├── promtail/
│   └── config.yaml
├── .env
├── Taskfile.yaml # Файл для работы с утилитой task
└── docker-compose.yaml
```
## Разворачивание на серверах
[grafana-loki-promtail-releases](https://github.com/grafana/loki/releases/) - здесь взять бинарники loki и promtail для дальнейшего разворота.
### promtail:
1. promtail должен быть развернут на всех целевых серверах.
2. запустить promtail через CRON (по другому не получится):
    1. taskschd.msc
    2. Создать задачу
	3. Имя - Promtail
	4. Проставить "Выполнять для всех пользователей"
	5. Триггер "При запуске"
	6. Действие - "Запуск программы" Программа - абсолютный путь до бинарника. Аргументы -  `--config.file={абсолютный путь до конфига (.yaml)}`
	7. При создании задачи CRON запросит данные учетной записи.
### loki:
1. Достаточно развернуть один инстанс loki и натравить на него инстансы promtail.
2. Полная аналогия с разворачиванием promtail.
### grafana:
[grafana-download](https://grafana.com/grafana/download)
1. Берем инсталлятор и устанавливаем на целевую машину.